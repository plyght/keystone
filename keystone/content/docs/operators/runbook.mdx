---
title: Operator Runbook
description: Production deployment, monitoring, and troubleshooting for Keystone
---

# Operator Runbook

This runbook covers production deployment, monitoring, and troubleshooting for Keystone.

## Production Deployment

### Prerequisites

- Rust toolchain (for building from source) or pre-built binary
- Access credentials for target hosting providers
- Appropriate network access to provider APIs

### Installation

#### Option 1: Build from Source

```bash
git clone https://github.com/keystone/keystone
cd keystone
cargo build --release
sudo cp target/release/keystone /usr/local/bin/
```

#### Option 2: Download Pre-built Binary

```bash
wget https://github.com/keystone/keystone/releases/latest/download/keystone-linux-x86_64
chmod +x keystone-linux-x86_64
sudo mv keystone-linux-x86_64 /usr/local/bin/keystone
```

### Initial Configuration

1. Initialize configuration:

```bash
keystone config init
```

2. Edit `~/.keystone/config.toml`:

```toml
audit_log_path = "/var/log/keystone"
cooldown_seconds = 60
rollback_window_seconds = 3600
daemon_bind = "127.0.0.1:9123"

[[maintenance_windows]]
start_hour = 2
end_hour = 6
days = ["Saturday", "Sunday"]
```

3. Set environment variables for provider credentials:

```bash
export VERCEL_TOKEN="..."
export VERCEL_PROJECT_ID="..."
```

4. Test configuration:

```bash
keystone config show
```

### Daemon Setup

For production app-signal rotation, run the daemon as a systemd service:

1. Create `/etc/systemd/system/keystone.service`:

```ini
[Unit]
Description=Keystone Secret Rotation Daemon
After=network.target

[Service]
Type=simple
User=keystone
Group=keystone
ExecStart=/usr/local/bin/keystone daemon-internal-run --bind 127.0.0.1:9123
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

Environment="VERCEL_TOKEN=..."
Environment="NETLIFY_AUTH_TOKEN=..."

[Install]
WantedBy=multi-user.target
```

2. Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable keystone
sudo systemctl start keystone
sudo systemctl status keystone
```

## Monitoring

### Health Checks

Check daemon status:

```bash
keystone daemon status
```

Or via HTTP:

```bash
curl http://127.0.0.1:9123/health
```

Expected response: `OK` with status 200.

### Audit Logs

Review recent rotations:

```bash
keystone audit --last 10
```

Filter by secret and environment:

```bash
keystone audit MY_API_KEY --env prod
```

### Lock Status

Check for stale locks:

```bash
ls -la ~/.keystone/locks/
```

Locks older than 5 minutes are automatically removed.

### Daemon Logs

View systemd logs:

```bash
sudo journalctl -u keystone -f
```

Or check the daemon log file:

```bash
tail -f ~/.keystone/daemon.log
```

## Troubleshooting

### Issue: "Lock already held"

**Symptom**: Rotation fails with "Lock already held by PID X"

**Cause**: Another rotation is in progress or a stale lock exists

**Resolution**:

1. Check if the PID is still running:

```bash
ps aux | grep <PID>
```

2. If the process is not running, the lock is stale and will auto-expire after 5 minutes

3. To force-remove a stale lock:

```bash
rm ~/.keystone/locks/<env>-<secret_name>.lock
```

### Issue: "Cooldown active"

**Symptom**: Rotation fails with "Cooldown active: wait Xs before rotating again"

**Cause**: Recent rotation within cooldown window

**Resolution**:

1. Wait for cooldown to expire
2. Or adjust cooldown in config:

```toml
cooldown_seconds = 30
```

3. Or override via environment:

```bash
KEYSTONE_COOLDOWN_SECONDS=30 keystone rotate ...
```

### Issue: Provider API Errors

**Symptom**: Rotation fails with HTTP error from provider

**Resolution**:

1. Verify credentials are correct:

```bash
env | grep VERCEL_TOKEN
```

2. Check provider API status

3. Review provider-specific IDs (project, site, service):

```bash
env | grep VERCEL_PROJECT_ID
```

4. Test with dry-run:

```bash
keystone rotate MY_API_KEY --env prod --service vercel --dry-run
```

### Issue: Daemon Won't Start

**Symptom**: `keystone daemon start` fails

**Resolution**:

1. Check if port is already in use:

```bash
lsof -i :9123
```

2. Check for stale PID file:

```bash
cat ~/.keystone/daemon.pid
ps aux | grep <PID>
```

3. Remove stale PID:

```bash
rm ~/.keystone/daemon.pid
```

4. Check daemon logs for errors

### Issue: Rollback Window Expired

**Symptom**: Rollback fails with "Rollback window expired"

**Cause**: Attempting to rollback after the configured window (default: 1 hour)

**Resolution**:

1. Proceed with manual key regeneration at provider
2. Or extend rollback window in config:

```toml
rollback_window_seconds = 7200
```

## Maintenance

### Log Rotation

Audit logs grow over time. Set up log rotation:

1. Create `/etc/logrotate.d/keystone`:

```
/var/log/keystone/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
}
```

2. Test:

```bash
sudo logrotate -d /etc/logrotate.d/keystone
```

### Backup Audit Logs

Audit logs contain signed metadata but no plaintext secrets. Back them up regularly:

```bash
rsync -av ~/.keystone/logs/ backup-server:/keystone-audit-logs/
```

### Update Keystone

1. Download new binary or rebuild from source
2. Stop daemon:

```bash
sudo systemctl stop keystone
```

3. Replace binary:

```bash
sudo cp keystone /usr/local/bin/
```

4. Restart daemon:

```bash
sudo systemctl start keystone
```

## Performance

### Expected Throughput

- Dev mode rotation: < 1 second
- Production rotation (no redeploy): 1-5 seconds
- Production rotation (with redeploy): 30-120 seconds (provider-dependent)

### Scaling Considerations

- Keystone is designed for manual and scheduled rotations, not high-frequency automation
- Cooldown prevents thrash (default: 60 seconds)
- File-based locking is sufficient for single-node deployments
- For multi-node setups, use a shared filesystem or distributed locking (not yet implemented)

## Security

### Credential Storage

- Never store plaintext credentials in config files
- Use environment variables or external secret managers
- Rotate Keystone's own provider tokens regularly

### Audit Log Integrity

- Audit logs are signed with Ed25519
- Verify signatures:

```bash
keystone audit MY_API_KEY --env prod
```

Look for "âœ“ valid" signature indicators.

### Access Control

- Restrict access to `~/.keystone/` directory
- Limit daemon bind address to localhost
- Use firewall rules to block external access to daemon port

## Incident Response

See [Incident Checklist](INCIDENT_CHECKLIST.md) for step-by-step incident response procedures.

