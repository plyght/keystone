---
title: Operator Runbook
description: Production deployment, monitoring, and troubleshooting for Birch
---

This runbook covers production deployment, monitoring, and troubleshooting for Birch.

## Production Deployment

### Prerequisites

- Rust toolchain (for building from source) or pre-built binary
- Access credentials for target hosting providers
- Appropriate network access to provider APIs

### Installation

#### Option 1: Build from Source

```bash
git clone https://github.com/plyght/birch
cd birch
cargo build --release
sudo cp target/release/birch /usr/local/bin/
```

#### Option 2: Download Pre-built Binary

```bash
wget https://github.com/plyght/birch/releases/latest/download/birch-linux-x86_64
chmod +x birch-linux-x86_64
sudo mv birch-linux-x86_64 /usr/local/bin/birch
```

### Initial Configuration

1. Initialize configuration:

```bash
birch config init
```

2. Edit `~/.birch/config.toml`:

```toml
audit_log_path = "/var/log/birch"
cooldown_seconds = 60
rollback_window_seconds = 3600
daemon_bind = "127.0.0.1:9123"

[[maintenance_windows]]
start_hour = 2
end_hour = 6
days = ["Saturday", "Sunday"]
```

3. Set environment variables for provider credentials:

```bash
export VERCEL_TOKEN="..."
export VERCEL_PROJECT_ID="..."
```

4. Test configuration:

```bash
birch config show
```

### Daemon Setup

For production app-signal rotation, run the daemon as a systemd service:

1. Create `/etc/systemd/system/birch.service`:

```ini
[Unit]
Description=Birch Secret Rotation Daemon
After=network.target

[Service]
Type=simple
User=birch
Group=birch
ExecStart=/usr/local/bin/birch daemon-internal-run --bind 127.0.0.1:9123
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

Environment="VERCEL_TOKEN=..."
Environment="NETLIFY_AUTH_TOKEN=..."

[Install]
WantedBy=multi-user.target
```

2. Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable birch
sudo systemctl start birch
sudo systemctl status birch
```

## Monitoring

### Health Checks

Check daemon status:

```bash
birch daemon status
```

Or via HTTP:

```bash
curl http://127.0.0.1:9123/health
```

Expected response: `OK` with status 200.

### Interactive Dashboard

Launch the TUI dashboard for real-time monitoring:

```bash
birch dashboard
```

The dashboard provides:
- **Live daemon status**: Running/stopped, PID, bind address
- **Scrollable audit logs**: Last 50 rotation events with timestamps
- **Pool health overview**: Status of all key pools with availability indicators
- **Metrics**: Total rotations, success rate, failures

**Keyboard controls:**
- `q` - Exit dashboard
- `r` - Force refresh (auto-refreshes every 5s)
- `↑`/`↓` - Scroll audit logs
- `Page Up`/`Page Down` - Fast scroll

**Use cases:**
- Monitor daemon uptime
- Track rotation success/failure in real-time
- Identify pool exhaustion issues
- Quick overview of system health

**Tip**: Run the dashboard in a tmux/screen session for persistent monitoring.

### Audit Logs

Review recent rotations:

```bash
birch audit --last 10
```

Filter by secret and environment:

```bash
birch audit MY_API_KEY --env prod
```

### Lock Status

Check for stale locks:

```bash
ls -la ~/.birch/locks/
```

Locks older than 5 minutes are automatically removed.

### Daemon Logs

View systemd logs:

```bash
sudo journalctl -u birch -f
```

Or check the daemon log file:

```bash
tail -f ~/.birch/daemon.log
```

## Troubleshooting

### Issue: "Lock already held"

**Symptom**: Rotation fails with "Lock already held by PID X"

**Cause**: Another rotation is in progress or a stale lock exists

**Resolution**:

1. Check if the PID is still running:

```bash
ps aux | grep <PID>
```

2. If the process is not running, the lock is stale and will auto-expire after 5 minutes

3. To force-remove a stale lock:

```bash
rm ~/.birch/locks/<env>-<secret_name>.lock
```

### Issue: "Cooldown active"

**Symptom**: Rotation fails with "Cooldown active: wait Xs before rotating again"

**Cause**: Recent rotation within cooldown window

**Resolution**:

1. Wait for cooldown to expire
2. Or adjust cooldown in config:

```toml
cooldown_seconds = 30
```

3. Or override via environment:

```bash
BIRCH_COOLDOWN_SECONDS=30 birch rotate ...
```

### Issue: Provider API Errors

**Symptom**: Rotation fails with HTTP error from provider

**Resolution**:

1. Verify credentials are correct:

```bash
env | grep VERCEL_TOKEN
```

2. Check provider API status

3. Review provider-specific IDs (project, site, service):

```bash
env | grep VERCEL_PROJECT_ID
```

4. Test with dry-run:

```bash
birch rotate MY_API_KEY --env prod --service vercel --dry-run
```

### Issue: Daemon Won't Start

**Symptom**: `birch daemon start` fails

**Resolution**:

1. Check if port is already in use:

```bash
lsof -i :9123
```

2. Check for stale PID file:

```bash
cat ~/.birch/daemon.pid
ps aux | grep <PID>
```

3. Remove stale PID:

```bash
rm ~/.birch/daemon.pid
```

4. Check daemon logs for errors

### Issue: Rollback Window Expired

**Symptom**: Rollback fails with "Rollback window expired"

**Cause**: Attempting to rollback after the configured window (default: 1 hour)

**Resolution**:

1. Proceed with manual key regeneration at provider
2. Or extend rollback window in config:

```toml
rollback_window_seconds = 7200
```

## Maintenance

### Log Rotation

Audit logs grow over time. Set up log rotation:

1. Create `/etc/logrotate.d/birch`:

```
/var/log/birch/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
}
```

2. Test:

```bash
sudo logrotate -d /etc/logrotate.d/birch
```

### Backup Audit Logs

Audit logs contain signed metadata but no plaintext secrets. Back them up regularly:

```bash
rsync -av ~/.birch/logs/ backup-server:/birch-audit-logs/
```

### Update Birch

1. Download new binary or rebuild from source
2. Stop daemon:

```bash
sudo systemctl stop birch
```

3. Replace binary:

```bash
sudo cp birch /usr/local/bin/
```

4. Restart daemon:

```bash
sudo systemctl start birch
```

## Performance

### Expected Throughput

- Dev mode rotation: < 1 second
- Production rotation (no redeploy): 1-5 seconds
- Production rotation (with redeploy): 30-120 seconds (provider-dependent)

### Scaling Considerations

- Birch is designed for manual and scheduled rotations, not high-frequency automation
- Cooldown prevents thrash (default: 60 seconds)
- File-based locking is sufficient for single-node deployments
- For multi-node setups, use a shared filesystem or distributed locking (not yet implemented)

## Security

### Credential Storage

- Never store plaintext credentials in config files
- Use environment variables or external secret managers
- Rotate Birch's own provider tokens regularly

### Audit Log Integrity

- Audit logs are signed with Ed25519
- Verify signatures:

```bash
birch audit MY_API_KEY --env prod
```

Look for "✓ valid" signature indicators.

### Access Control

- Restrict access to `~/.birch/` directory
- Limit daemon bind address to localhost
- Use firewall rules to block external access to daemon port

## Incident Response

See [Incident Checklist](/docs/operators/incident-checklist) for step-by-step incident response procedures.

