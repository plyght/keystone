---
title: Usage Guide
description: Complete guide to using Birch for secret rotation
---

This guide covers all aspects of using Birch for secret rotation in development and production.

## Basic Commands

### Rotate a Secret

```bash
birch rotate SECRET_NAME --env ENV [--service SERVICE] [OPTIONS]
```

**Arguments:**
- `SECRET_NAME`: Name of the secret to rotate
- `--env`: Environment (dev/staging/prod)
- `--service`: Service/provider (vercel/netlify/render/etc.)

**Options:**
- `--dry-run`: Preview changes without applying
- `--redeploy`: Trigger redeploy after rotation
- `--value`: Provide custom secret value
- `--env-file`: Path to `.env` file (dev mode only)

### Rollback a Secret

```bash
birch rollback SECRET_NAME --env ENV [--service SERVICE] [OPTIONS]
```

**Options:**
- `--redeploy`: Trigger redeploy after rollback

### Daemon Management

```bash
birch daemon start [--bind ADDRESS]
birch daemon stop
birch daemon status
```

### View Audit Logs

```bash
birch audit [SECRET_NAME] [OPTIONS]
```

**Options:**
- `--env`: Filter by environment
- `--last N`: Show last N entries

### Monitor with Dashboard

```bash
birch dashboard
```

Launch an interactive TUI dashboard that displays:
- Daemon status and health
- Recent audit logs (scrollable)
- Key pool status overview
- Rotation metrics and success rates

Use `q` to quit, `r` to refresh, arrow keys to scroll.

### Manage Key Pools

```bash
birch pool <ACTION>
```

**Actions:**
- `init`: Create a new key pool
- `add`: Add a key to pool
- `list`: Display pool keys
- `remove`: Remove a key
- `import`: Import keys from file
- `status`: Show pool statistics

## Detailed Workflows

<Cards>
  <Card title="App-Signal Rotation" href="/docs/usage/app-signals" description="Trigger rotation from your application" />
  <Card title="Key Pools" href="/docs/usage/key-pools" description="Automatic rotation with multiple keys" />
</Cards>

## Safety Features

### Dry-Run Mode

Always test with dry-run first:

```bash
birch rotate MY_API_KEY --env prod --service vercel --dry-run
```

### Cooldown Period

Prevents rapid successive rotations (default: 60 seconds):

```bash
# Will fail if rotated recently
birch rotate MY_API_KEY --env prod --service vercel
# Error: Cooldown active: wait 45s before rotating again
```

### Single-Writer Locks

Prevents concurrent rotations of the same secret:

```bash
# Terminal 1
birch rotate MY_API_KEY --env prod --service vercel

# Terminal 2 (simultaneously)
birch rotate MY_API_KEY --env prod --service vercel
# Error: Lock already held by PID 12345
```

### Maintenance Windows

Production rotations can be restricted to specific time windows:

```toml
[[maintenance_windows]]
start_hour = 2
end_hour = 6
days = ["Saturday", "Sunday"]
```

Outside these windows, you'll be prompted to confirm.

### Confirmation Prompts

Production rotations always require explicit confirmation:

```bash
birch rotate MY_API_KEY --env prod --service vercel
# Preview: New secret value: ***xyz
# Update 'MY_API_KEY' in prod environment? (y/n): 
```

## Key Pool Rotation

### What Are Key Pools?

Key pools allow you to pre-configure multiple API keys for automatic rotation. When a rate limit is detected, Birch automatically switches to the next available key from the pool.

### Setting Up a Key Pool

#### Create the Pool

```bash
# Create pool with inline keys
birch pool init TIKTOK_API_KEY --keys "sk_key1,sk_key2,sk_key3"

# Or from a file
birch pool init TIKTOK_API_KEY --from-file ./tiktok-keys.txt
```

#### Check Pool Status

```bash
birch pool status TIKTOK_API_KEY
# Pool: TIKTOK_API_KEY
# Status: Ready
# Total keys:      3
# Available:       3 (100%)
```

#### Rotate Using Pool

When you rotate, Birch automatically uses the pool:

```bash
birch rotate TIKTOK_API_KEY --env prod --service vercel
# Using key pool for 'TIKTOK_API_KEY' (2 available, 1 exhausted)
# Marked current key as exhausted
# Rotating secret 'TIKTOK_API_KEY' in env 'prod'
```

### Automatic Rotation on Rate Limit

Your application can trigger automatic rotation when hitting rate limits:

```javascript
// In your application code
async function makeApiCall() {
  try {
    const response = await fetch(API_URL, {
      headers: { 'Authorization': `Bearer ${process.env.TIKTOK_API_KEY}` }
    });
    
    if (response.status === 429) { // Rate limit hit
      // Signal birch daemon to rotate
      await fetch('http://localhost:9123/rotate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          secret_name: 'TIKTOK_API_KEY',
          env: 'prod',
          service: 'vercel'
        })
      });
      
      // Retry after a short delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      return makeApiCall();
    }
    
    return response;
  } catch (error) {
    console.error('API call failed:', error);
  }
}
```

### Pool Management

#### Add Keys to Pool

```bash
birch pool add TIKTOK_API_KEY --key "sk_new_key"
```

#### View Pool Status

```bash
birch pool list TIKTOK_API_KEY
# 0: Exhausted ***abc (last used: 2024-01-15 12:00:00)
# 1: Active ***xyz (last used: 2024-01-15 14:30:22)
# 2: Available ***def
```

#### Remove Exhausted Keys

```bash
birch pool remove TIKTOK_API_KEY --index 0
```

#### Import Bulk Keys

```bash
# keys.txt format (one per line):
# sk_abc123xyz
# sk_def456uvw
# sk_ghi789rst

birch pool import TIKTOK_API_KEY --from-file ./keys.txt
```

### Best Practices

1. **Always maintain at least 3 keys** in the pool
2. **Monitor pool status** regularly with `birch pool status`
3. **Set up alerts** when pool is running low:
   ```bash
   # Check available keys and alert if < 2
   available=$(birch pool status TIKTOK_API_KEY | grep Available | awk '{print $2}')
   if [ "$available" -lt 2 ]; then
     echo "Warning: Low key pool - only $available keys remaining"
   fi
   ```
4. **Rotate pools regularly** even without rate limits
5. **Remove exhausted keys** after confirming they're no longer needed

### Pool Storage

Pools are stored encrypted at `~/.birch/pools/<SECRET_NAME>.json`:
- Keys are encrypted using ChaCha20Poly1305
- Status tracking (active/available/exhausted)
- Usage statistics and timestamps
- Automatic pool saves on rotation

## Common Patterns

### Scheduled Rotations

Use cron for periodic rotations:

```bash
# Rotate weekly on Sunday at 3 AM
0 3 * * 0 /usr/local/bin/birch rotate MY_API_KEY --env prod --service vercel
```

### Multi-Environment Rotation

Rotate across all environments:

```bash
#!/bin/bash
for env in dev staging prod; do
  birch rotate MY_API_KEY --env $env --service vercel
done
```

### Conditional Rotation

Rotate only if approaching expiry:

```bash
# In your app (example in bash)
if [ "$DAYS_UNTIL_EXPIRY" -lt 7 ]; then
  curl -X POST http://localhost:9123/rotate \
    -H "Content-Type: application/json" \
    -d '{"secret_name": "MY_API_KEY", "env": "prod", "service": "vercel"}'
fi
```

## Using the SDK

For automatic rotation in Node.js applications, use the [Birch SDK](/docs/sdk) instead of manual daemon calls:

```typescript
import '@inaplight/birch-client/auto';

// Automatic rotation on 429 responses
const response = await fetch(API_URL, {
  headers: { Authorization: `Bearer ${process.env.API_KEY}` }
});
```

See the [SDK documentation](/docs/sdk) for complete setup and examples.

## Next Steps

- [Set up the SDK](/docs/sdk) for automatic rotation in your applications
- [Learn about specific providers](/docs/connectors)
- [Read the operator runbook](/docs/operators/runbook)
- [Implement app-signal rotation](/docs/usage/app-signals)

